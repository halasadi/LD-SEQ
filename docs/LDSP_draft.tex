\documentclass[10pt,a4paper,draft]{article}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\title{LDSP- Linear Detection of Selection in Pooled sequence data}
\date{}
\setlength\parindent{0pt}
\author{Hussein Al-Asadi, Matthew Stephens}
\begin{document}
\maketitle
\section{Introduction}
\textbf{Phase I - better estimate frequency using haplotypic information}:
The Intuition is that data at each SNP are binomial counts, which help estimate the frequency of a SNP in a pool. But by combining information across multiple corrected SNPs, you can improve the estimated frequency of the test SNP. \\

We demonstrate the feasibility of such an endeavor by a simple probability calculation: Say the objective is to estimate the frequency of SNP $1$ in a  pool. Denote SNP $1$ as $S_1$ which can take values from $\{0,1\}$.

Consider another SNP $2$ ($S_2$). For simplicity, we suppose perfect correlation between the two SNPs (e.g. $P(S_1 = 1 | S_2 = 1) = 1 \ \& \ P(S_1 = 0 | S_2 = 0) = 1$) \\

\textbf{one estimate}: $P(S_1 = 1) \approx \frac{n_1^1}{n_1}$ \\
\textbf{second estimate}:  $P(S_1 = 1) = P(S_1 = 1 | S_2 = 0)P(S_2=0) + P(S_1 = 1 | S_2 = 1)P(S_2=1) = P(S_1 = 1 | S_2 = 1)P(S_2 = 1) = P(S_2 = 1) \approx \frac{n_2^1}{n_2}$ \\

where $n_j^1$ is the number of "1" allele reads at SNP $j$ and $n_j^0$ is the number of "0" allele reads at SNP $j$ and $n_j = n_j^1 + n_j^0$. 

We now have two estimates of $P(S_1=1)$ using two different pieces of data. Therefore, effectively we have doubled our coverage for SNP $1$. If instead of only one perfectly correlated SNP, we have a 1000 then sequencing only at 1x coverage will be like sequencing at 1000x coverage! \\

% put figure here of a pool of 1-0 haplotypes then on 1-x haplotype on the right

\textbf{Phase II - detect selection using improved estimates}:
To detect selection, we find sites that have had significant changes in their frequency compared to the founding population. We can do this by using a linear model which also allows us to model genetic drift with a normal error term.

\section{Phase I - calculating effective coverage}
\subsection{Prior from Li \& Stephens}
Consider one lineage for now.

Let  $y = (y_1, y_2, ..., y_p)'$ denote the vector of allele frequencies in the study sample.
Let $E[y_{i}] = \mu_{i}$ and the frequency of the test SNP be $y_{t}$  and $M$ denote the $2m$x$p$ panel (i.e. $2m$ haplotypes and $p$ SNPs). As in (Wen \& Stephens, 2010), we assume 
\begin{equation}
\vec{y} |M \sim N_p(\mu, \Sigma) \label{eq:prior}
\end{equation}
(Wen \& Stephens, 2010) derived the estimates for $\mu$ and $\Sigma$ from the haplotype copying model presented in (Li \& Stephens, 2003).
\begin{equation}
\hat{\mu} = (1-\theta)f^{panel} + \frac{\theta}{2}1 
\end{equation}
\begin{equation}
\hat{\Sigma} = (1-\theta)^2S + \frac{\theta}{2}(1-\frac{\theta}{2})I
\end{equation}
and $S$ is obtained from $\Sigma^{panel}$, specifically,
 \begin{equation}
   S_{i,j} = \left\{
     \begin{array}{lr}
       \Sigma_{i,j}^{panel} &  i =j\\
       e^{-\frac{-\rho_{i,j}}{2m}} \Sigma_{i,j}^{panel} &  i \neq j
     \end{array}
   \right.
\end{equation} 
$\rho_{i,j} = -4Nc_{i,j}d_{i,j}$ where $d_{i,j}$ is the physical distance between markers $i$ and $j$, $N$ is the effective diploid population size, $c_{i,j}$ is the average rate of crossover per unit physical distance, per meiosis, between sites $i$ and $j$ (so that $c_{i,j}d_{i,j}$ is the genetic distance between sites $i$ and $j$). 

and,
\begin{equation}
\theta = \frac{(\sum_{i=1}^{2m-1} \frac{1}{i})^{-1}}{2m + (\sum_{i=1}^{2m-1} \frac{1}{i})^{-1}}
\end{equation}

\subsection{Data at SNP $i$}
Let $(n_i^0, n_i^1)$ denote the counts of "0" and "1" alleles at SNP $i$ and $n_i = n_i^0 + n_i^1$. Then 
\begin{align*}
n_i^1 | y_i \sim Bin(n_i, y_i) \ \dot{\sim}  \ N(n_iy_i, n_iy_i(1-y_i)) \label{eq:napprox}
\end{align*}
where $y_i$ is the true population frequency of the SNP $i$ "1" allele. 


\begin{equation}
\implies \frac{n_i^1}{n_i} | y_i \ \dot{\sim} \ N(y_i, \frac{y_i(1-y_i)}{n_i})
\end{equation}
let $\hat{y_i} = \frac{n_i^1}{n_i}$\\
Next we replace $y_i$ by $\hat{y_i}$ in the variance for tractibility issues. Therefore,
\begin{equation} 
 \hat{y_i} | y_i \ \dot{\sim} \ N(y_i, \frac{\hat{y_i}(1-\hat{y_i})}{n_i}) \label{bin}
\end{equation}

We can expand equation \ref{bin} to p-dimensions (we can since the $\hat{y_i} | y_i$ are independent)
\begin{equation}
\hat{\vec{y}} | \vec{y} \ \dot{\sim} \ N_p(\vec{y}, \ diag(\epsilon_1,...,\epsilon_p)) 
\end{equation}
where $\epsilon_i = \frac{\hat{y}_i (1-\hat{y}_i)}{n_i}$ 

We re-name the variables such that $y_i^{obs} = \hat{y_i}$, $y^{true}_i = y_i$ and make the approximation exact.
\begin{equation}
\vec{y^{obs}} | \vec{y^{true}} \sim  N_p(\vec{y^{true}}, \ diag(\epsilon_1,...,\epsilon_p)) \label{obs_true}
\end{equation}
We assume that, given $y^{true}$, the observations $y^{obs}$ are conditionally independent of the panel data ($M$). \\

If the coverage is low, then the estimate of the frequency of a SNP can be 0 (i.e. $\frac{n_i^1}{n_i}=0$) which will introduce complications when we must invert matrices. Therefore we make the following modification,
\begin{equation}
y_i^{obs} = \frac{n_i^1+\frac{1}{2}}{n_i + 1}
\end{equation} 

\subsection{Incorporating Dispersion}
In the distribution of $\vec{y}$, we assumed that the panel and study individuals are from the sample population, and the parameters $\theta$ and $\rho$ are estimated without error. Deviations from these assumptions will cause over-dispersion: the true allele frequencies will lie further from their expected values than the model predicts. To allow this, we modify equation \ref{eq:prior} by introducing an over-dispersion parameter $\sigma^2$.
\begin{equation}
\vec{y^{true}}|M \sim N_p(\hat{\mu}, \sigma^2\hat{\Sigma})
\end{equation}

We estimate $\sigma^2$ by maximizing the multivariate normal likelihood:
\begin{equation}
 \vec{y^{obs}}|M \sim N_p(\hat{\mu}, \sigma^2\hat{\Sigma} + diag(\epsilon_1,...,\epsilon_p))
\end{equation}


\subsection{Calculating the Posterior}
To obtain the distribution for the true frequencies conditional on the observed data, we use Bayes theorem 
\begin{align*}
P(\vec{y^{true}} | \vec{y^{obs}}, M) \propto P(\vec{y^{obs}} | \vec{y^{true}}) P(\vec{y^{true}}|M)
\end{align*}

Let, 
\begin{equation} \label{barsigma}
\bar{\Sigma} = \big(\frac{\hat{\Sigma}^{-1}}{\sigma^2} + diag(\frac{1}{\epsilon_1},..., \frac{1}{\epsilon_p})\big)^{-1}
\end{equation}
and,
\begin{equation}
\bar{\theta} = \bar{\Sigma} \ (\frac{\hat{\Sigma}^{-1}}{\sigma^2}\hat{\mu} + diag(\frac{1}{\epsilon_1},..., \frac{1}{\epsilon_p}) \ \vec{y^{obs}})
\end{equation}
Then since the normal is in the conjugate family,

\begin{equation}
\vec{y^{true}} | \vec{y^{obs}}, M \sim N_p(\bar{\theta}, \bar{\Sigma})
\end{equation}
Therefore a natural point estimate for $\vec{y^{true}}$ is $\bar{\theta}$.

%% two figures: where sample is from the panel and other not to showcase prior bias

\subsection{Calculating the likelihood to avoid bias of the prior mean}
As mentioned above, we assume the the panel and sample individuals are drawn from the same population. This is the never the case in reality but in some applications, the frequencies of alleles of interest have changed significantly but the correlation structure has changed slightly (i.e. very little recombination between nearby SNPs). Therefore we would just like to erase the influence of the prior mean. To do this, we calculate $L(y_t^{true})$. \\

Denote the test SNP by the subscript $t$. Then,

\begin{equation}
L(y_t^{true}) = P(y^{obs} | y_t^{true}, M) \propto \frac{P(y_t^{true}| y^{obs}, M)}{P(y_t^{true} | M)}
\end{equation}
From the above equations, we can see:

\begin{equation}
y_t^{true} | y_t^{obs}, M \sim N(\bar{\theta_t}, \bar{\Sigma}_{tt})
\end{equation}
and,
\begin{equation}
y_t^{true} | M \sim N(\theta_t, \Sigma_{tt})
\end{equation}

Thus,
\begin{equation}
L(y_t^{true}) \propto e^{ \frac{-(y_t^{true} - \bar{\theta}_t)^2}{2\bar{\Sigma}_{tt}} + \frac{(y_t^{true} - \theta_t)^2}{2\Sigma_{tt}} }
\end{equation}
Completing the square, we can see
\begin{equation}
\frac{-(y_t^{true} - \bar{\theta}_t)^2}{2\bar{\Sigma}_{tt}} + \frac{(y_t^{true} - \theta_t)^2}{2\Sigma_{tt}} = \frac{1}{2}(\frac{1}{\Sigma_{tt}} - \frac{1}{\bar{\Sigma}_{tt}}) (y_t^{true} - \frac{\theta_t\bar{\Sigma}_{tt} - \bar{\theta}_t\Sigma_{tt}}{\bar{\Sigma}_{tt}-\Sigma_{tt}})^2 + K
\end{equation}
Let,
\begin{equation}
\mu_t = \frac{\theta_t\bar{\Sigma}_{tt} - \bar{\theta}_t\Sigma_{tt}}{\bar{\Sigma}_{tt}-\Sigma_{tt}}
\end{equation}
and,
\begin{equation}
\sigma^2_t = \frac{1}{\frac{1}{\Sigma_{tt}} - \frac{1}{\bar{\Sigma}_{tt}}}
\end{equation}
Because the normal is in the conjugate family,
\begin{equation}
L(y_t^{true}) = pdf \ of \ N(\mu_t, \sigma^2_t)
\end{equation}

Therefore the MLE of $y_t^{true}$ is $\mu_t$.

% place figure here showing how our estimate is the optima

\subsection{Calculating the inverse of the covariance matrix}
When $\hat{\Sigma}$ is singular, we decompose using SVD and calculate the pseudo-inverse,
\begin{equation}
\hat{\Sigma} = U 
\begin{bmatrix} S & 0 \\ 0 & 0 \end{bmatrix} V^T
\end{equation}
where the pseudo-inverse is,
\begin{equation}
\hat{\Sigma}^{+} = V \begin{bmatrix} S^{-1} & 0 \\ 0 & 0 \end{bmatrix} U^T
\end{equation}
We modify \ref{barsigma} which is now probably non-singular?
\begin{equation}
\bar{\Sigma} =  \big(\frac{\hat{\Sigma}^{+}}{\sigma^2} + diag(\frac{1}{\epsilon_1},..., \frac{1}{\epsilon_p})\big)^{-1}
\end{equation}

\subsection{Computing the Effective Coverage}
To calculate effective coverage ($n_e$) and the effective proportion ($p_e$), we approximate the normal with a binomial which can be justified using the laplace approximation.
Let,
\begin{equation} 
p_e = \mu_t
\end{equation}
and,
\begin{equation}
\frac{p_e(1-p_e)}{n_e}= \sigma_t^2
\end{equation}
Then,
\begin{equation}
n_e = \frac{\mu_t(1-\mu_t)}{\sigma_t^2}
\end{equation}

\subsection{large-scale simulation}
use MS to generate haplotypes and then evolve population with recombination - can use Forqs here or maybe better to write my own code.

\section{Phase II - estimating $\beta$}
Let $f_{i,k,j}$ denote the frequency of the $j$th SNP in population $i$ and replicate $k$. Then,

\begin{equation}
log(\frac{1-f_{i,k,j}}{f_{i,k,j}}) = \mu_j + \beta_{j} g_i + \epsilon
\end{equation}

where $\epsilon \sim N_(0, \sigma_d^2)$, $\sigma_d^2$ is the variance due to drift, $\mu_j$ is the frequency of the $j$th SNP in the founding population and 
\[
   g_{i} = \left\{
     \begin{array}{lr}
       -1 &  i =0\\
        0 &  i =1 \\
        1 &  i =2
     \end{array}
   \right.
\]

The intuition here is that sites with large $\beta$ coefficients are under selection.
\end{document}